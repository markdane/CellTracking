---
title: "ilastik tracking of HeLa cells"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

Exploration of segmentation, tracking and processing of HeLa cells using Fiji for registration and ilastik for pixel classification, segmentation, tracking and analysis.


```{r "setup", include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      echo=FALSE, warning=FALSE, message=FALSE,
                      cache=TRUE)
library(tidyverse)
library(RColorBrewer)
library(gplots)
library(scales)
library(tiff)
library(EBImage)


#Setup colors
spectralPal <- brewer.pal(11,"Spectral")[11:1]


```

```{r get_data, , cache.lazy = FALSE}

#Read in a CSV with ilastik tracking data
data_path <- "/eppec/storage/groups/heiserlab/image_scratch/"
nuclear_dir_name <- "TxRed_Reg"
reporter_dir_name <- "GFP_Reg"
barcode <- "HE_E_L_049_01_1"

#Filter thresholds
max_nuclear_diff <- .25
min_nuclear_diff <- -.25
max_reporter_diff <- .25
min_reporter_diff <- -.25
max_nuclear_dis <- 100
max_Size_in_pixels_0_nuclear <- 225

well_location_dirs <- dir(paste0(data_path, barcode), pattern = "[[:alnum:]]*_[[:digit:]]*", full.names = TRUE)
#message("DEBUG limiter in place")
#Get the nuclear data
raw_data <- lapply(well_location_dirs, function(well_location_dir){
  nuclear_data_filename <- dir(paste0(well_location_dir,"/",nuclear_dir_name),pattern = "CSV-Table", full.names = TRUE)
  if(is_empty(nuclear_data_filename)) stop("No nuclear data found in ", well_location_dir)
  nuclear_data <- read_csv(nuclear_data_filename) %>%
    mutate(Location = str_remove(well_location_dir, ".*/"),
           Well = str_remove(Location,"_.*"),
           Location_trackId = str_c(Location, trackId))
  #Get the reporter data for the same image location
  reporter_data_filename <- dir(paste0(well_location_dir,"/",reporter_dir_name),pattern = "CSV-Table", full.names = TRUE)
  if(is_empty(reporter_data_filename)) stop("No reporter data found in ", well_location_dir)
  reporter_cell_data <- read_csv(reporter_data_filename)
  
  #Get and add the GFP background data
  reporter_background_data_filename <- dir(paste0(well_location_dir,"/",reporter_dir_name),pattern = "background", full.names = TRUE)
  reporter_data <- read_csv(reporter_background_data_filename) %>%
    mutate(frame = 0:(n()-1)) %>%
    select(frame, Background_median) %>%
    right_join(reporter_cell_data) %>%
    mutate(Mean_Intensity_0_raw_reporter = Mean_Intensity_0,
           Mean_Intensity_0 = Mean_Intensity_0_raw_reporter - Background_median*2^16)
  
  all_data <- nuclear_data %>%
    inner_join(reporter_data, by=c("frame", "Center_of_the_object_0", "Center_of_the_object_1"))
  # missing_nuclear_data <- nuclear_data %>%
  #   anti_join(all_data, by=c("frame", "Center_of_the_object_0", "Center_of_the_object_1"))
  #   missing_reporter_data <- reporter_data %>%
  #   anti_join(all_data, by=c("frame", "Center_of_the_object_0", "Center_of_the_object_1"))
  colnames(all_data) <- str_replace_all(colnames(all_data), "[.]x","_nuclear")
  colnames(all_data) <- str_replace_all(colnames(all_data), "[.]y","_reporter")
  
return(all_data)
}) %>%
  bind_rows()

#addmetadata
raw_data_metadata <- read_csv(paste0(data_path,"/",barcode,"/Analysis/",barcode,"_exp_metadata.csv")) %>%
  select(matches("Well|CellLine-1$|Drug|Ligand|Reporter|Image")) %>%
  distinct() %>%
  left_join(raw_data, by=c("Well"))

colnames(raw_data_metadata)[str_detect(colnames(raw_data_metadata),"-")] <- str_replace_all(colnames(raw_data_metadata)[str_detect(colnames(raw_data_metadata),"-")], "-","_")
raw_data_metadata <- mutate(raw_data_metadata, Time = frame*Image_period)

first_valid_frame <- 2
processing1 <- raw_data_metadata %>%
  filter(lineageId_nuclear > 1,
         trackId_nuclear > 1,
         frame >= first_valid_frame) %>% #limit to valid tracks, lineages and microscope ready data 
  group_by(Location_trackId) %>%
  mutate(Track_length = n()) %>%
  ungroup() %>% 
  #remove dividing, disappearing and appearing cells
  filter(Track_length==max(length(unique(frame)))) %>% 
  group_by(Location_trackId) %>%
  mutate(Mean_Intensity_0_nuclear_sum = sum(Mean_Intensity_0_nuclear),
         Mean_Intensity_0_nuclear_T0 = Mean_Intensity_0_nuclear[frame==first_valid_frame],
         Mean_Intensity_0_nuclear_T0norm = Mean_Intensity_0_nuclear/Mean_Intensity_0_nuclear_T0,
         Mean_Intensity_0_nuclear_T0norm_sum = sum(Mean_Intensity_0_nuclear_T0norm)) %>%
  mutate(Mean_Intensity_0_reporter_sum = sum(Mean_Intensity_0_reporter),
         Mean_Intensity_0_reporter_T0 = Mean_Intensity_0_reporter[frame==first_valid_frame],
         Mean_Intensity_0_reporter_T0norm = Mean_Intensity_0_reporter/Mean_Intensity_0_reporter_T0,
         Mean_Intensity_0_raw_reporter_T0 = Mean_Intensity_0_raw_reporter[frame==first_valid_frame],
         Mean_Intensity_0_raw_reporter_T0norm = Mean_Intensity_0_raw_reporter/Mean_Intensity_0_raw_reporter_T0,
         Mean_Intensity_0_reporter_T0norm_sum = sum(Mean_Intensity_0_reporter_T0norm),
         Movement_0_nuclear = c(diff(Object_Center_0_nuclear),0),
         Movement_1_nuclear = c(diff(Object_Center_1_nuclear),0),
         Distance_01_nuclear = sqrt(Movement_0_nuclear^2 + Movement_1_nuclear^2),
         Mean_Intensity_0_nuclear_T0norm_diff =  c(diff(Mean_Intensity_0_nuclear_T0norm),0),
         Mean_Intensity_0_reporter_T0norm_diff = c(diff(Mean_Intensity_0_reporter_T0norm),0),
         Size_in_pixels_0_nuclear_diff = c(diff(Size_in_pixels_0_nuclear),0),
         facet_label = paste0(Ligand_1_conc," ", Ligand_1_concUnit," ",Ligand_1,": ", Well),
         facet_label = factor(facet_label, levels = c("0 ng_per_ml NRG1: B3", "0.5 ng_per_ml NRG1: B2","1 ng_per_ml NRG1: B1", "2.5 ng_per_ml NRG1: A3", "5 ng_per_ml NRG1: A2" ,"10 ng_per_ml NRG1: A1"), ordered = TRUE)) %>%
  ungroup()

```




```{r evaluateOutliers, fig.width=4, fig.height=4}

#Filter thresholds
max_nuclear_dis <- 10

#identify outliers based on size, motion and change in intensity
df <- processing1 %>%
  filter(!Distance_01_nuclear==0)
p <- ggplot(processing1, aes(x = Distance_01_nuclear)) + 
  geom_histogram(binwidth = .02) +
  coord_cartesian(x = c(0,2))+
  labs(title = "Distance moved between frames",
       x = "pixels")
p

df <- processing1 %>%
  filter(Distance_01_nuclear >=2)
p <- ggplot(df, aes(x = Distance_01_nuclear)) + 
  geom_histogram(binwidth = 1) +
  geom_vline(xintercept = max_nuclear_dis, color="blue")+
  coord_cartesian(x = c(2,100))+
  labs(title = "Distance moved between frames",
       x = "pixels")
p

#identify outliers based on size, motion and change in intensity
mean_size_in_pixels = mean(processing1$Size_in_pixels_0_reporter)
sd_size_in_pixels = sd(processing1$Size_in_pixels_0_reporter)
mean_size_in_pixels_0_nuclear_diff = mean(processing1$Size_in_pixels_0_nuclear_diff)
sd_size_in_pixels_0_nuclear_diff = sd(processing1$Size_in_pixels_0_nuclear_diff)

p <- ggplot(processing1, aes(x = Size_in_pixels_0_reporter)) + 
  geom_histogram(binwidth = 1) +
  geom_vline(xintercept = mean_size_in_pixels+3*sd_size_in_pixels, colour="blue")+
    geom_vline(xintercept = mean_size_in_pixels-3*sd_size_in_pixels, colour="blue")+
  #coord_cartesian(x = c(0,2))+
  labs(title = "Size in pixels in each frame",
       subtitle = "mean +/- 3sd shown in blue",
       x = "pixels")
p

p <- ggplot(processing1, aes(x = Well, y = Size_in_pixels_0_nuclear_diff)) + 
  geom_violin() +
   geom_hline(yintercept = mean_size_in_pixels_0_nuclear_diff+3*sd_size_in_pixels_0_nuclear_diff, colour="blue")+
    geom_hline(yintercept = mean_size_in_pixels_0_nuclear_diff-3*sd_size_in_pixels_0_nuclear_diff, colour="blue")+
    labs(title = "Change in size",
       x = "pixels")
p

#identify outliers based on size, motion and change in intensity
mean_Mean_Intensity_0_reporter_T0norm = mean(processing1$Mean_Intensity_0_reporter_T0norm)
sd_Mean_Intensity_0_reporter_T0norm = sd(processing1$Mean_Intensity_0_reporter_T0norm)
mean_Mean_Intensity_0_reporter_T0norm_diff = mean(processing1$Mean_Intensity_0_reporter_T0norm_diff)
sd_Mean_Intensity_0_reporter_T0norm_diff = sd(processing1$Mean_Intensity_0_reporter_T0norm_diff)

p <- ggplot(processing1, aes(x = Mean_Intensity_0_reporter_T0norm)) + 
  geom_histogram(binwidth = .02) +
  geom_vline(xintercept = mean_Mean_Intensity_0_reporter_T0norm+3*sd_Mean_Intensity_0_reporter_T0norm, colour="blue")+
    geom_vline(xintercept = mean_Mean_Intensity_0_reporter_T0norm-3*sd_Mean_Intensity_0_reporter_T0norm, colour="blue")+
  #coord_cartesian(x = c(0,2))+
  labs(title = "Normalized reporter intensity in each frame",
       subtitle = "mean +/- 3sd shown in blue",
       x = "intensity")
p

p <- ggplot(processing1, aes(x = Mean_Intensity_0_reporter_T0norm_diff)) + 
  geom_histogram(binwidth = .002) +
  geom_vline(xintercept = mean_Mean_Intensity_0_reporter_T0norm_diff+3*sd_Mean_Intensity_0_reporter_T0norm_diff, colour="blue")+
    geom_vline(xintercept = mean_Mean_Intensity_0_reporter_T0norm_diff-3*sd_Mean_Intensity_0_reporter_T0norm_diff, colour="blue")+
  #coord_cartesian(x = c(0,2))+
  labs(title = "Normalized reporter intensity differences between frames",
       subtitle = "mean +/- 3sd shown in blue",
       x = "intensity")
p

p <- ggplot(processing1, aes(x = Well, y = Mean_Intensity_0_reporter_T0norm_diff)) + 
  geom_violin() +
    geom_hline(yintercept = mean_Mean_Intensity_0_reporter_T0norm_diff+3*sd_Mean_Intensity_0_reporter_T0norm_diff, colour="blue")+
    geom_hline(yintercept = mean_Mean_Intensity_0_reporter_T0norm_diff-3*sd_Mean_Intensity_0_reporter_T0norm_diff, colour="blue")+
  labs(title = "Normalized reporter intensity differences",
       subtitle = "mean +/- 3sd shown in blue",
       x = "Well",
       y = "T0 normalized intensity difference")
p


df <- processing1 %>%
  filter(Distance_01_nuclear >=10)
#Show traces that are being filtered
p <- ggplot(df, aes(x = Center_of_the_object_0, y = Center_of_the_object_1, colour = factor(trackId_nuclear))) + 
  geom_path(size=.5) +
  guides(colour=FALSE) +
  scale_y_reverse() +
  labs(title = "Motion over time of filtered tracks") +
  facet_wrap(~Location)
p


df <-  processing1 %>%
  filter(Distance_01_nuclear <10)

#Show traces that are not being filtered
p <- ggplot(df, aes(x = Center_of_the_object_0, y = Center_of_the_object_1, colour = factor(trackId_nuclear))) + 
  geom_path(size=.5) +
  guides(colour=FALSE) +
  scale_y_reverse() +
  labs(title = "Motion over time of tracks in dataset") +
  facet_wrap(~Location)
p

```

```{r}

clean_processed_data <- processing1 %>%
  group_by(Well) %>%
  select(Location_trackId, Mean_Intensity_0_reporter_T0norm_sum, Well) %>%
  distinct() %>%
  arrange(desc(Mean_Intensity_0_reporter_T0norm_sum)) %>%
  group_by(Well) %>%
  mutate(Mean_Intensity_0_reporter_T0norm_sum_rank = row_number()) %>%
  ungroup() %>%
  select(Location_trackId, Mean_Intensity_0_reporter_T0norm_sum_rank) %>%
  left_join(processing1, by="Location_trackId")

#Intensity filter
#Calculate changes in intensity
clean_data <- clean_processed_data %>%
  group_by(Location_trackId) %>%
  arrange(Time) %>%
  filter(Mean_Intensity_0_reporter_T0norm > mean_Mean_Intensity_0_reporter_T0norm+3*sd_Mean_Intensity_0_reporter_T0norm|Mean_Intensity_0_reporter_T0norm <mean_Mean_Intensity_0_reporter_T0norm-3*sd_Mean_Intensity_0_reporter_T0norm|Mean_Intensity_0_reporter_T0norm_diff > mean_Mean_Intensity_0_reporter_T0norm_diff+3*sd_Mean_Intensity_0_reporter_T0norm_diff|Mean_Intensity_0_reporter_T0norm_diff <mean_Mean_Intensity_0_reporter_T0norm_diff-3*sd_Mean_Intensity_0_reporter_T0norm_diff|Distance_01_nuclear > max_nuclear_dis|Size_in_pixels_0_nuclear > mean_size_in_pixels+3*sd_size_in_pixels|Size_in_pixels_0_nuclear < mean_size_in_pixels-3*sd_size_in_pixels|Size_in_pixels_0_nuclear_diff>mean_size_in_pixels_0_nuclear_diff+3*sd_size_in_pixels_0_nuclear_diff|Size_in_pixels_0_nuclear_diff<mean_size_in_pixels_0_nuclear_diff-3*sd_size_in_pixels_0_nuclear_diff) %>%
  select(Location_trackId) %>%
  distinct() %>%
  anti_join(clean_processed_data,., by = "Location_trackId") %>%
  ungroup()

  #Get cyto data processed by EBImage
# cyto_data <- read_csv(paste0(beacon_dirs[1],"/Cyto_data.csv")) %>%
#   group_by(trackId_nuclear) %>%
#   mutate(Nuclei_b.mean_T0 = Nuclei_b.mean[frame==0],
#          Nuclei_b.mean_T0norm = Nuclei_b.mean/Nuclei_b.mean_T0,
#          Cyto_b.mean_T0 = Cyto_b.mean[frame==0],
#          Cyto_b.mean_T0norm = Cyto_b.mean/Cyto_b.mean_T0,
#          CytoNucleiRatio_b.mean = Nuclei_b.mean/Cyto_b.mean,
#          CytoNucleiRatio_b.mean_T0 = CytoNucleiRatio_b.mean[frame==0],
#          CytoNucleiRatio_b.mean_T0norm = CytoNucleiRatio_b.mean/CytoNucleiRatio_b.mean_T0) %>%
#   ungroup()

#Debug on a subset of the data
set.seed(42)
clean_data_subset <- sample(unique(clean_data$Location_trackId), size = .1*length(unique(clean_data$Location_trackId)), replace = FALSE)
clean_data_small <- clean_data %>%
  filter(Location_trackId %in% clean_data_subset) %>%
  arrange(Location, frame)

#rm(processing1, raw_data, raw_data_metadata, clean_processed_data)

```
 
Nuclei motion of a subset of the  data.  
 
```{r samplePlots, fig.width=8, fig.height=6}

p <- ggplot(clean_data_small, aes(x = Center_of_the_object_0, y = Center_of_the_object_1, colour = factor(trackId_nuclear))) + 
  geom_path(size=1.2) +
  guides(colour=FALSE) +
  scale_y_reverse() +
  labs(title = "Motion over time") +
  facet_wrap(~Location)
p

```

Cell counts that include divsion, appearance and disappearance. Tracks labeled as invalid in ilastik are removed.  

```{r cellCount, fig.width=8, fig.height=6}

df <- raw_data_metadata %>%
    filter(lineageId_nuclear > 1,
         trackId_nuclear > 1) %>% #limit to valid tracks and lineages
  group_by(Location, Time) %>%
  summarise(Cell_count = n())

p <- ggplot(df, aes(x = Time, y = Cell_count)) +
  geom_line(alpha=.3, size=.8) +
  #coord_cartesian(ylim=c(2000,2300)) +
  guides(colour=FALSE) +
  labs(title = "Cell count over time",
       y = "Cell Count",
       x = unique(raw_data_metadata$Image_period_timeUnit)) +
  facet_wrap(~Location)
p
```


####Heatmaps of all data after outlier filtering.  


```{r reporterheatmap, fig.width=8, fig.height=5, eval=TRUE}
#Heatmap with time columns and location)trackId rows, colour based on reporter intensity
loProb <- quantile(clean_data$Mean_Intensity_0_reporter_T0norm, probs=.01)
highProb <- quantile(clean_data$Mean_Intensity_0_reporter_T0norm, probs=.99)

df <- clean_data %>%
  #filter(Well=="A1") %>%
  mutate(Mean_Intensity_0_reporter_T0norm = scales::squish(Mean_Intensity_0_reporter_T0norm, range = c(loProb, highProb)))
  

p <- ggplot(df, aes(x=Time, y = Mean_Intensity_0_reporter_T0norm_sum_rank,
                    fill = Mean_Intensity_0_reporter_T0norm,
                    colour = Mean_Intensity_0_reporter_T0norm)) + 
  geom_tile() + 
  scale_fill_distiller(palette = "Spectral") + 
  scale_colour_distiller(palette = "Spectral") + 
  scale_y_reverse() + 
  guides(colour=FALSE) +
  labs(x = "Time (minutes)",
       y = "Cells",
       fill = "Intensity",
       title = "Reporter intensity (T0 norm)") +
  theme_bw(base_size = ) + 
  theme(panel.border = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"),
        strip.text = element_text(size=rel(.5)))+
  facet_wrap(~facet_label, nrow=1)
p

```

####Reporter intensity density plots.  

```{r densityPlots, fig.height=12, fig.width=8}

df <- clean_data %>%
  filter(Time %in% c((first_valid_frame+1)*unique(Image_period),30,60,90,120, 150, 177)) %>%
  mutate(Mean_Intensity_0_reporter_T0norm = scales::squish(Mean_Intensity_0_reporter_T0norm, range = c(loProb, highProb)))

p <- ggplot(df, aes(x = Mean_Intensity_0_reporter_T0norm, fill = factor(Ligand_1_conc))) +
  geom_density(alpha=.3) +
  labs(x = "Intensity",
       fill = "Ligand\nconcentration\nng/ml",
       title = "Reporter intensity density plots") + 
  theme_bw(base_size = ) + 
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.border = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))+
  facet_wrap(~Time, ncol=1, labeller = label_both)
p

p <- ggplot(df, aes(x = Mean_Intensity_0_reporter_T0norm, fill = factor(Ligand_1_conc))) +
  geom_histogram(bins = 100, alpha=.5) +
  labs(x = "Intensity",
       fill = "Ligand\nconcentration\nng/ml",
       title = "Reporter intensity histograms") + 
  theme_bw(base_size = ) + 
  theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.border = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))+
  facet_wrap(~Time, ncol=1, labeller = label_both)
p

p <- ggplot(df, aes(x = factor(Ligand_1_conc), y = Mean_Intensity_0_reporter_T0norm, fill = factor(Ligand_1_conc))) +
  geom_violin(alpha=.3) +
  labs(x = "Ligand concentration (ng/ml)",
       y = "Reporter intensity",
       fill = "Ligand\nconcentration\nng/ml",
       title = "Reporter intensity density plots") + 
  theme_bw(base_size = ) + 
  theme(panel.border = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))+
  facet_wrap(~Time, ncol=1, labeller = label_both)
p

```

####Sample images arranged with time at the top of the y axis and increasing down while ligand concentration increases along the x axis.  

```{r sampleImages, fig.height=12, fig.width=12}

#Get images to be displayed
#need to recreate path
#get metadata to select the correct images
df <- clean_data %>%
  filter(Time %in% c(9, 30,60,90,120, 150, 177)) %>%
  select(Well, frame, Location, Time, Ligand_1_conc) %>%
  mutate(frame = sprintf("%02i",frame)) %>%
  distinct()

#create paths to the images
wldf <- tibble(Well_Location_dir = well_location_dirs)%>%
  mutate(Location = str_remove(Well_Location_dir,".*/")) %>%
  right_join(df) %>%
  mutate(ImagePath = paste0(Well_Location_dir,"/GFP_Reg/",Location,"_GFP_Scene1Interval",frame,".tif")) %>%
  filter(str_detect(Location,"_1")) %>%
  arrange(Time, Ligand_1_conc) %>%
  select(Time, Ligand_1_conc, ImagePath)

imgs <- readImage(wldf$ImagePath)
imgt <- tile(imgs,nx=length(unique(wldf$Ligand_1_conc)))
  
#create a tile of images from one time point at each concentration
p <- ggplot(df, aes(x = factor(Ligand_1_conc), y = Time)) +
  geom_tile(colour="black")+
  scale_y_reverse(breaks = c(9, 30,60,90,120, 150, 177)) +
  annotation_raster(imgt,  -Inf, Inf, -Inf, Inf) + 
  labs(x = "Concentration (ng/ml",
       y = "Minute",
       title = "Reporter images over time") + 
  theme(panel.ontop = FALSE,
        axis.text = element_text(size=20),
        axis.title = element_text(size=24),
        text = element_text(size=28))
p


```

Mean nuclear intensity T0 normalized for a sampled set of cells that are present during the entire experiment.  

```{r nuclearIntensityByCell, fig.width=8, fig.height=6}
set.seed(42)
df <- clean_data %>%
  group_by(Well) %>%
  select(Location_trackId, Well) %>%
  distinct() %>%
  sample_n(size = 12) %>%
  inner_join(clean_data, by = c("Well", "Location_trackId"))

p <- ggplot(clean_data, aes(x = Time, y = Mean_Intensity_0_nuclear_T0norm, group = factor(Location_trackId))) +
  geom_line(colour="lightgray", alpha=.8, size=.4) +
  guides(colour=FALSE) +
  labs(title = "Nuclear intensity over time by well",
       y = "Nuclear intensity (normalized to T0)",
       x = unique(raw_data_metadata$Image_period_timeUnit)) + 
  facet_wrap(~facet_label)
p <- p + geom_line(data=df, aes(colour=factor(trackId_reporter)))
p


```

Mean reporter intensity T0 normalized over time and by well. The gray lines are from all cells in the well. The colored lines are a random sample of cells in each well.  

```{r reporterIntensityByCell, fig.width=8, fig.height=6}
set.seed(42)
df <- clean_data %>%
  group_by(Well) %>%
  select(Location_trackId, Well) %>%
  distinct() %>%
  sample_n(size = 12) %>%
  inner_join(clean_data, by = c("Well", "Location_trackId"))


p <- ggplot(clean_data, aes(x = Time, y = Mean_Intensity_0_reporter_T0norm, group = factor(Location_trackId))) +
  geom_line(colour="lightgray", alpha=.8, size=.4) +
  guides(colour=FALSE) +
  labs(title = "Reporter intensity over time by well",
       y = "Reporter intensity (normalized to T0)",
       x = unique(raw_data_metadata$Image_period_timeUnit)) + 
  facet_wrap(~facet_label)
p <- p + geom_line(data=df, aes(colour=factor(trackId_reporter)))
p

```

Background corrected and raw mean reporter intensity T0 normalized. The solid line is the background corrected data. The dotted line is the raw data. 

```{r compareBackgroundCorrection, fig.width=8, fig.height=6}
set.seed(42)
df <- clean_data %>%
  filter(Well==unique(Well)[1]) %>%
  select(Location_trackId, Well) %>%
  distinct() %>%
  sample_n(size = 12) %>%
  inner_join(clean_data, by = c("Well", "Location_trackId")) 


p <- ggplot(df, aes(x = Time, y = Mean_Intensity_0_reporter_T0norm, colour = (Location_trackId))) +
  geom_line(alpha=.8, size=.4) +
  guides(colour=FALSE) +
  labs(title = "Reporter intensity over time by well",
       y = "Reporter intensity (normalized to T0)",
       x = unique(raw_data_metadata$Image_period_timeUnit))
p <- p + geom_line(aes(y = Mean_Intensity_0_raw_reporter_T0norm), linetype = 2)
p

foo <- df %>%
  filter(Location_trackId %in% unique(Location_trackId)[c(2,6)]) %>%
  select(Time, Location_trackId, Mean_Intensity_0_reporter_T0norm,Mean_Intensity_0_raw_reporter_T0norm)

p <- ggplot(foo, aes(x = Time, y = Mean_Intensity_0_reporter_T0norm, colour = (Location_trackId))) +
  geom_line(alpha=.8, size=.4) +
  guides(colour=FALSE) +
  labs(title = "Reporter intensity over time by well",
       y = "Reporter intensity (normalized to T0)",
       x = unique(raw_data_metadata$Image_period_timeUnit))
p <- p + geom_line(data=foo, aes(y = Mean_Intensity_0_raw_reporter_T0norm), linetype = 2)
p

foo <- df %>%
  filter(Location_trackId %in% unique(Location_trackId)[c(2,6)]) %>%
  select(Time, Location_trackId, Mean_Intensity_0_reporter,Mean_Intensity_0_raw_reporter)

p <- ggplot(foo, aes(x = Time, y = Mean_Intensity_0_reporter, colour = (Location_trackId))) +
  geom_line(alpha=.8, size=.4) +
  guides(colour=FALSE) +
  labs(title = "Reporter intensity over time by well",
       y = "Reporter intensity",
       x = unique(raw_data_metadata$Image_period_timeUnit))
p <- p + geom_line(data=foo, aes(y = Mean_Intensity_0_raw_reporter), linetype = 2)
p

```


Mean reporter intensity at various doses  

```{r reporterIntensityByCellbyDose, fig.width=8, fig.height=6}
df <- clean_data_small %>%
  group_by(Location, Time) %>%
  summarise(Mean_Intensity_0_reporter_T0norm = mean(Mean_Intensity_0_reporter_T0norm),
            Ligand_1_conc = unique(Ligand_1_conc)) %>%
  ungroup()

p <- ggplot(df, aes(x = Time, y = Mean_Intensity_0_reporter_T0norm, colour=Location)) +
  geom_line() +
    labs(title = "Reporter intensity",
       y = "Reporter intensity (normalized to T0)",
       x = unique(raw_data_metadata$Image_period_timeUnit))
p

df <- clean_data_small %>%
  group_by(Well, Time) %>%
  summarise(Mean_Intensity_0_reporter_T0norm = mean(Mean_Intensity_0_reporter_T0norm),
                        Ligand_1_conc = unique(Ligand_1_conc)) %>%
  ungroup()

p <- ggplot(df, aes(x = Time, y = Mean_Intensity_0_reporter_T0norm, colour=Well)) +
  geom_line() + 
    labs(title = "Reporter intensity dose responses",
       y = "Reporter intensity (normalized to T0)",
       x = unique(raw_data_metadata$Image_period_timeUnit)) 
p

p <- ggplot(df, aes(x = Time, y = Mean_Intensity_0_reporter_T0norm, colour=factor(Ligand_1_conc))) +
  geom_line() + 
    labs(title = "Reporter intensity dose responses",
       y = "Reporter intensity (normalized to T0)",
       x = unique(raw_data_metadata$Image_period_timeUnit),
       colour = "Ligand\nconcentration(ng/ml)") 
p



```

Mean reporter intensity T0 normalized for all cells that are present during the entire experiment.  

```{r cytoReporterIntensityCell, fig.width=8, fig.height=6, eval=FALSE}
df <- cyto_data 


p <- ggplot(df, aes(x = frame, y = log10(Cyto_b.mean), colour = factor(trackId_nuclear))) +
  geom_line(alpha=.3, size=.8) +
    guides(colour=FALSE) +
  labs(title = "Mean reporter intensity in cytoplasm",
       y = "Reporter intensity",
       x = "Frame") 
p <- p + geom_smooth(aes(x = frame,  y = log10(Cyto_b.mean)), colour="black", method="lm")
p

p <- ggplot(df, aes(x = frame, y = log10(Cell_b.mean), colour = factor(trackId_nuclear))) +
  geom_line(alpha=.3, size=.8) +
    guides(colour=FALSE) +
  labs(title = "Mean reporter intensity in the whole cell",
       y = "Reporter intensity",
       x = "Frame") 
p <- p + geom_smooth(aes(x = frame,  y = log10(Cell_b.mean)), colour="black", method="lm")
p

p <- ggplot(df, aes(x = frame, y = log10(Nuclei_b.mean), colour = factor(trackId_nuclear))) +
  geom_line(alpha=.3, size=.8) +
    guides(colour=FALSE) +
  labs(title = "Mean reporter intensity in the nucleus",
       y = "Reporter intensity",
       x = "Frame") 
p <- p + geom_smooth(aes(x = frame,  y = log10(Nuclei_b.mean)), colour="black", method="lm")
p

 p <- ggplot(df, aes(x = frame, y = log10(Cyto_b.mean/Nuclei_b.mean), colour = factor(trackId_nuclear))) +
  geom_point(alpha=.3, size=.8) +
    guides(colour=FALSE) +
  labs(title = "Mean reporter intensity ratio cyto/nucleus",
       y = "Reporter intensity",
       x = "Frame") 
p <- p + geom_smooth(aes(x = frame,  y = log10(Cyto_b.mean/Nuclei_b.mean)), colour="black", method="lm")
p

 p <- ggplot(df, aes(x = frame, y = log10(Nuclei_b.mean_T0norm), colour = factor(trackId_nuclear))) +
  geom_point(alpha=.3, size=.8) +
    guides(colour=FALSE) +
  labs(title = "Mean reporter intensity in the nucleus",
       y = "Reporter intensity",
       x = "Frame") 
p <- p + geom_smooth(aes(x = frame,  y = log10(Nuclei_b.mean_T0norm)), colour="black", method="lm")
p


 p <- ggplot(df, aes(x = frame, y = CytoNucleiRatio_b.mean_T0norm, colour = factor(trackId_nuclear))) +
  geom_point(alpha=.3, size=.8) +
    guides(colour=FALSE) +
  labs(title = "Mean reporter intensity ratio cyto/nucleus",
       y = "Reporter intensity",
       x = "Frame") 
p <- p + geom_smooth(aes(x = frame,  y = CytoNucleiRatio_b.mean_T0norm), colour="black", method="loess")
p


```

